name: Auto Post to WordPress

on:
  workflow_dispatch:
    inputs:
      post_limit:
        description: "How many posts to process this run (e.g. 20, 2000)"
        required: true
        default: "20"
      mode:
        description: "skip (no update) or update (update existing posts)"
        required: true
        default: "skip"
      wp_status:
        description: "draft or publish"
        required: true
        default: "publish"

  schedule:
    - cron: "0 * * * *" # 毎時0分

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      # WordPress
      WP_BASE_URL: ${{ secrets.WP_BASE_URL }}
      WP_USER: ${{ secrets.WP_USER }}
      WP_APP_PASS: ${{ secrets.WP_APP_PASS }}

      # Google Sheets
      GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
      SHEET_NAME: "シート4"

      # 投稿制御
      MAX_TAGS: "10"
      RANDOM_PICK: "1"

      # ========= 重要：cronでもpublishさせる =========
      POST_LIMIT: ${{ github.event_name == 'schedule' && '30' || github.event.inputs.post_limit || '30' }}
      MODE: ${{ github.event_name == 'schedule' && 'skip' || github.event.inputs.mode || 'skip' }}
      WP_STATUS: ${{ github.event_name == 'schedule' && 'publish' || github.event.inputs.wp_status || 'publish' }}

      # 既存投稿のアイキャッチを毎回更新したいなら 1
      FORCE_FEATURED: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm install

      - name: Run posting script
        run: node scripts/post-to-wp.js
